<!DOCTYPE HTML>
<html lang="en" >
    <head>
<meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>socket </title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Cici's notebook."><meta name="generator" content="Jekyll (using style of GitBook)"><meta name="keywords" content="c++, Socket"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-splitter/splitter.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/base16.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/" type="image/x-icon">

<link rel="stylesheet" href="/assets/custom_css/code.css">

</head>
    <body>
        <div class="book">
            
            <div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="">
            
                <a href="/" onclick="pageScrollToTop(this)">
                    Cici&#39;s notebook
                </a>
            </li>
            <li class="divider"></li>
            
            
	
	
	<li class="chapter" data-level="1.1" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> C++ </a><ul>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 寫C++在MAC </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/editor/xcode" onclick="pageScrollToTop(this)"> Xcode</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/editor/vscode" onclick="pageScrollToTop(this)"> VS on Mac</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/editor/clang" onclick="pageScrollToTop(this)"> 安裝VS在MAC(實作)</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/editor/vsDebug" onclick="pageScrollToTop(this)"> VS Debug</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/editor/cmake" onclick="pageScrollToTop(this)"> Cmake on Mac</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/editor/supportc11" onclick="pageScrollToTop(this)"> Xcode支援C++11以上</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/editor/rvo" onclick="pageScrollToTop(this)"> 關閉RVO</a>
        
            
        </li></ul></li>
	
	
	<li class="">
    	<a href="/pages/c/basic/simpleTraditionC" onclick="pageScrollToTop(this)"> 台陸指標相關名詞差異</a>
        
            
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 基本知識 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/basic/format" onclick="pageScrollToTop(this)"> 程式碼格式</a>
        
            
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 資料型態 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/basic/typicalRange" onclick="pageScrollToTop(this)"> 資料型態範圍</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/charType" onclick="pageScrollToTop(this)"> char字元</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/boolType" onclick="pageScrollToTop(this)"> bool</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/printformat" onclick="pageScrollToTop(this)"> 整數與浮點數</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/typedef" onclick="pageScrollToTop(this)"> typedef類型別名</a>
        
            
        </li></ul></li>
	
	
	<li class="">
    	<a href="/pages/c/basic/param" onclick="pageScrollToTop(this)"> 參數與引數</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/scope" onclick="pageScrollToTop(this)"> 變數可見範圍與生命週期</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/loop" onclick="pageScrollToTop(this)"> 迴圈</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/rand" onclick="pageScrollToTop(this)"> 亂數</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/main" onclick="pageScrollToTop(this)"> main</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/include" onclick="pageScrollToTop(this)"> include與define</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/basic/linux_shell" onclick="pageScrollToTop(this)"> Linux shell指令</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 編譯 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/editor/openssh_server" onclick="pageScrollToTop(this)"> 安裝openssh-server</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/compile/makefile" onclick="pageScrollToTop(this)"> makefile</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/compile/gdb" onclick="pageScrollToTop(this)"> gdb</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/compile/core_dump" onclick="pageScrollToTop(this)"> gdb core dump</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/compile/gdb_attach_pid" onclick="pageScrollToTop(this)"> gdb attach pid</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 指標 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/pointer/pointer" onclick="pageScrollToTop(this)"> 指標基本觀念</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/pointer/pointerConst" onclick="pageScrollToTop(this)"> const與指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/pointer/pointerVoid" onclick="pageScrollToTop(this)"> void*任何資料型態的指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/pointer/nullptr" onclick="pageScrollToTop(this)"> 0 == nullptr == NULL</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/pointer/wildPointer" onclick="pageScrollToTop(this)"> 指標位址是無效內容</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/pointer/pointerToPointer" onclick="pageScrollToTop(this)"> 指標的指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/pointer/pointerArithmetic" onclick="pageScrollToTop(this)"> 指標運算</a>
        
            
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 指向陣列的指標 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/array/array" onclick="pageScrollToTop(this)"> 陣列</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/array/pointerToArray" onclick="pageScrollToTop(this)"> 一維陣列與指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/array/dynamicArrays" onclick="pageScrollToTop(this)"> 陣列與動態配置記憶體</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/array/qsort" onclick="pageScrollToTop(this)"> qsort排序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/array/array2dimen" onclick="pageScrollToTop(this)"> 二維陣列</a>
        
            
        </li></ul></li>
	
	
	<li class="">
    	<a href="/pages/c/array/arrayOfPointers" onclick="pageScrollToTop(this)"> 指標陣列存放多個記憶體位址</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 字串 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/array/charArray" onclick="pageScrollToTop(this)"> char 字串</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/array/pointerCharArr" onclick="pageScrollToTop(this)"> char字串指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/string_convert" onclick="pageScrollToTop(this)"> string convert</a>
        
            
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 實作字串函式 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/basic/strLen" onclick="pageScrollToTop(this)"> 取得字串長度</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/reverseStr" onclick="pageScrollToTop(this)"> 原地反轉字串</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/integerToStr" onclick="pageScrollToTop(this)"> 整數轉成字串</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/stringToInt" onclick="pageScrollToTop(this)"> 字串轉成數字</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/stringCopy" onclick="pageScrollToTop(this)"> 字串拷貝</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/stringCat" onclick="pageScrollToTop(this)"> 字串連結</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/strchr" onclick="pageScrollToTop(this)"> 字元搜尋</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/strcmp" onclick="pageScrollToTop(this)"> 字串比較</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/strstr" onclick="pageScrollToTop(this)"> 字串搜尋</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/delstr" onclick="pageScrollToTop(this)"> 刪除字元</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/split" onclick="pageScrollToTop(this)"> split 切割字串</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/xml" onclick="pageScrollToTop(this)"> xml搜尋</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/string/chineseAscii" onclick="pageScrollToTop(this)"> ASCII與中文</a>
        
            
        </li></ul></li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 參考 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/reference/reference" onclick="pageScrollToTop(this)"> 參考</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/reference/refToPointer" onclick="pageScrollToTop(this)"> 參考指向指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/reference/l_ref_func" onclick="pageScrollToTop(this)"> 等號左邊的函式</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 函式 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/function/func_def" onclick="pageScrollToTop(this)"> 函式宣告與定義</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/callByValue" onclick="pageScrollToTop(this)"> 函式傳值與傳回值</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/func_param_pointer" onclick="pageScrollToTop(this)"> 函式參數為指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/callByRef" onclick="pageScrollToTop(this)"> 函式傳參考</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/func_return_ref" onclick="pageScrollToTop(this)"> 函式傳回值是參考</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/func_overload" onclick="pageScrollToTop(this)"> 函式多載</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/func_inline" onclick="pageScrollToTop(this)"> 內嵌函式</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/func_default_param" onclick="pageScrollToTop(this)"> 函式參數預設值</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/functionPointer" onclick="pageScrollToTop(this)"> 函式指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/func_ref" onclick="pageScrollToTop(this)"> 函式參考</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/auto_func" onclick="pageScrollToTop(this)"> auto與函式</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/lambda" onclick="pageScrollToTop(this)"> lambda</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/function/using_func_pointer" onclick="pageScrollToTop(this)"> using函式指標別名</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 記憶體 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/dynamicMemory/memoryLayout" onclick="pageScrollToTop(this)"> 記憶體配置</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dynamicMemory/newDelete" onclick="pageScrollToTop(this)"> new/delete</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dynamicMemory/nothrow" onclick="pageScrollToTop(this)"> 記憶體不足</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dynamicMemory/memset" onclick="pageScrollToTop(this)"> memset</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dynamicMemory/memory_interval" onclick="pageScrollToTop(this)"> 記憶體間隔計算</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 結構 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/struct/struct_def" onclick="pageScrollToTop(this)"> 定義結構</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/struct_char" onclick="pageScrollToTop(this)"> 結構與字串</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/struct_init" onclick="pageScrollToTop(this)"> 初始化結構</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/struct_array" onclick="pageScrollToTop(this)"> 結構陣列</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/struct_pointer" onclick="pageScrollToTop(this)"> 指標指向結構</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/nestedStruct" onclick="pageScrollToTop(this)"> 巢狀結構</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/arrayInStruct" onclick="pageScrollToTop(this)"> 結構中的陣列</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/pointerInStruct" onclick="pageScrollToTop(this)"> 結構中的指標</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/struct/linked_list" onclick="pageScrollToTop(this)"> 鏈結串列</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 資料結構與演算法 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/arrayList" onclick="pageScrollToTop(this)"> ArrayList實作</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/arrayListExtCap" onclick="pageScrollToTop(this)"> ArrayList擴展容量</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/linkedList" onclick="pageScrollToTop(this)"> 單向鏈結串列實作</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/doublelinkedList" onclick="pageScrollToTop(this)"> 雙向鏈結串列實作</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/stack" onclick="pageScrollToTop(this)"> Stack實作</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/queue" onclick="pageScrollToTop(this)"> Queue實作</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/circular_queue" onclick="pageScrollToTop(this)"> circular queue環狀佇列</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/bubbleSort" onclick="pageScrollToTop(this)"> 氣泡排序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/insertSort" onclick="pageScrollToTop(this)"> 插入排序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/quickSort" onclick="pageScrollToTop(this)"> 快速排序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/mergeSort" onclick="pageScrollToTop(this)"> 合併排序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/dataStruct/recursion" onclick="pageScrollToTop(this)"> 遞迴</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 類別與物件 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/class/class" onclick="pageScrollToTop(this)"> 類別與物件</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/enum" onclick="pageScrollToTop(this)"> Enum列舉</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/constructor" onclick="pageScrollToTop(this)"> 建構子與解構子</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/anonymous_obj" onclick="pageScrollToTop(this)"> 匿名物件</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/temp_obj" onclick="pageScrollToTop(this)"> 臨時物件temporary object</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/conversion_function" onclick="pageScrollToTop(this)"> 建構子轉型</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/init_list" onclick="pageScrollToTop(this)"> 建構子初始化列表</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/member_class" onclick="pageScrollToTop(this)"> 成員變數是類別</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/static_class" onclick="pageScrollToTop(this)"> 靜態類別變數與函式</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/copy_constructor" onclick="pageScrollToTop(this)"> 拷貝函式</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/deep_shallow_copy" onclick="pageScrollToTop(this)"> 深淺拷貝</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/operator_assign" onclick="pageScrollToTop(this)"> operator=()</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/functor" onclick="pageScrollToTop(this)"> operator()物件函式</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/operator_add" onclick="pageScrollToTop(this)"> operator+()</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/operator_equal" onclick="pageScrollToTop(this)"> operator==()</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/class/inheritance" onclick="pageScrollToTop(this)"> 繼承</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 轉型 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/conversion/implicit" onclick="pageScrollToTop(this)"> 自動轉型</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/conversion/explicit" onclick="pageScrollToTop(this)"> 強制轉型</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 模板 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/template/function_template" onclick="pageScrollToTop(this)"> 函式模板</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/function_class_template" onclick="pageScrollToTop(this)"> 類別中函式模板</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/special_template" onclick="pageScrollToTop(this)"> 模板特製化</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/class_template" onclick="pageScrollToTop(this)"> 類別模板</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/stack_template" onclick="pageScrollToTop(this)"> Stack實作(int Array)</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/foreach_template" onclick="pageScrollToTop(this)"> foreach模板</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/findif_template" onclick="pageScrollToTop(this)"> find_if模板</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/template/bsort_template" onclick="pageScrollToTop(this)"> 氣泡排序模板</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> STL Containers </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/stl/string" onclick="pageScrollToTop(this)"> string</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/stl/iterator" onclick="pageScrollToTop(this)"> iterator疊代器</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/stl/pair" onclick="pageScrollToTop(this)"> pair</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/stl/map" onclick="pageScrollToTop(this)"> map</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> c11 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/c11/init_list" onclick="pageScrollToTop(this)"> 初始化initializer list</a>
        
            
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> 左值與右值 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/c11/rvalue/l_r_value" onclick="pageScrollToTop(this)"> l-value與r-value</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/rvalue/l_r_ref" onclick="pageScrollToTop(this)"> l-value參考與r-value參考</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/rvalue/constRef" onclick="pageScrollToTop(this)"> const與參考</a>
        
            
        </li></ul></li>
	
	
	<li class="">
    	<a href="/pages/c/c11/move_operator" onclick="pageScrollToTop(this)"> 移動建構子與移動指派運算子</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/forward" onclick="pageScrollToTop(this)"> forward</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/functional" onclick="pageScrollToTop(this)"> functional</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/bind" onclick="pageScrollToTop(this)"> bind綁定</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/variadic" onclick="pageScrollToTop(this)"> 可變參數模板</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/c11/callback" onclick="pageScrollToTop(this)"> callback</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> pthread </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/pthread/create_pthread" onclick="pageScrollToTop(this)"> 建立pthread</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> Thread(C11) </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/thread/create_thread" onclick="pageScrollToTop(this)"> 建立thread</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/thread/join" onclick="pageScrollToTop(this)"> 執行緒記憶體釋放</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/thread/this_thread" onclick="pageScrollToTop(this)"> this_thread</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/thread/mutex" onclick="pageScrollToTop(this)"> 互斥鎖Mutex</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/thread/condition_variable" onclick="pageScrollToTop(this)"> condition_variable</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> time </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/time/chrono" onclick="pageScrollToTop(this)"> 程式執行時間</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/time/time" onclick="pageScrollToTop(this)"> time</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> file </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/file/file_io" onclick="pageScrollToTop(this)"> File IO</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/file/file_desc" onclick="pageScrollToTop(this)"> File description</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> linux系統c函式庫 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/libc/errno" onclick="pageScrollToTop(this)"> 取得錯誤訊息</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/file_io" onclick="pageScrollToTop(this)"> 檔案目錄操作</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/system_execl" onclick="pageScrollToTop(this)"> system與execl</a>
        
            
        </li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> process相關 </a><ul>
	
	
	<li class="">
    	<a href="/pages/c/libc/signal" onclick="pageScrollToTop(this)"> signal訊號</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/exit" onclick="pageScrollToTop(this)"> exit終止程序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/fork" onclick="pageScrollToTop(this)"> fork 複製程序</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/kill" onclick="pageScrollToTop(this)"> kill</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/shared_memory" onclick="pageScrollToTop(this)"> Shared Memory共用記憶體</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/semaphore" onclick="pageScrollToTop(this)"> semaphore</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/libc/semaph_que" onclick="pageScrollToTop(this)"> semaphore作為condition</a>
        
            
        </li></ul></li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> socket </a><ul>
	
	
	<li class="active">
    	<a href="/pages/c/socket/socket" onclick="pageScrollToTop(this)"> socket</a>
        
            
                <ul><li><a href="#socket函式" onclick="mobilePageScrollToAnchor(this)" >socket()函式</a><ul><li><a href="#參數domain" onclick="mobilePageScrollToAnchor(this)" >參數domain</a></li><li><a href="#參數type" onclick="mobilePageScrollToAnchor(this)" >參數type</a></li><li><a href="#參數protocol" onclick="mobilePageScrollToAnchor(this)" >參數protocol</a><ul><li><a href="#ipproto_tcp" onclick="mobilePageScrollToAnchor(this)" >IPPROTO_TCP</a></li><li><a href="#ipproto_udp" onclick="mobilePageScrollToAnchor(this)" >IPPROTO_UDP</a></li></ul></li></ul></li><li><a href="#big-endian" onclick="mobilePageScrollToAnchor(this)" >big-endian</a></li><li><a href="#port轉成big-endian" onclick="mobilePageScrollToAnchor(this)" >port轉成big-endian</a></li><li><a href="#sockaddr結構" onclick="mobilePageScrollToAnchor(this)" >sockaddr結構</a></li><li><a href="#sockaddr_in結構" onclick="mobilePageScrollToAnchor(this)" >sockaddr_in結構</a></li><li><a href="#ip轉成big-endian" onclick="mobilePageScrollToAnchor(this)" >ip轉成big-endian</a></li><li><a href="#client建立socket" onclick="mobilePageScrollToAnchor(this)" >client建立socket</a></li><li><a href="#server" onclick="mobilePageScrollToAnchor(this)" >server</a><ul><li><a href="#systemctl" onclick="mobilePageScrollToAnchor(this)" >systemctl</a></li><li><a href="#防火牆" onclick="mobilePageScrollToAnchor(this)" >防火牆</a></li><li><a href="#open-listen-port" onclick="mobilePageScrollToAnchor(this)" >open listen port</a></li><li><a href="#編譯執行程式" onclick="mobilePageScrollToAnchor(this)" >編譯執行程式</a></li><li><a href="#server程式碼" onclick="mobilePageScrollToAnchor(this)" >server程式碼</a></li></ul></li><li><a href="#封裝socket" onclick="mobilePageScrollToAnchor(this)" >封裝Socket</a><ul><li><a href="#client" onclick="mobilePageScrollToAnchor(this)" >client</a></li><li><a href="#server-1" onclick="mobilePageScrollToAnchor(this)" >server</a></li></ul></li></ul>

            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/socket/fork_socket" onclick="pageScrollToTop(this)"> 多工的socket</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/c/socket/file_socket" onclick="pageScrollToTop(this)"> Socket傳送檔案</a>
        
            
        </li></ul></li></ul></li>
	
	
	<li class="chapter" data-level="1.1" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> ffmpeg </a><ul>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> xcode </a><ul>
	
	
	<li class="">
    	<a href="/pages/ffmpeg/install_ffmpeg_mac" onclick="pageScrollToTop(this)"> FFmpeg on Mac</a>
        
            
        </li></ul></li>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> android </a><ul>
	
	
	<li class="">
    	<a href="/pages/ffmpeg/ndk" onclick="pageScrollToTop(this)"> NDK</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/ffmpeg/jni" onclick="pageScrollToTop(this)"> JNI</a>
        
            
        </li>
	
	
	<li class="">
    	<a href="/pages/ffmpeg/cmake" onclick="pageScrollToTop(this)"> cmake</a>
        
            
        </li></ul></li></ul></li>
	
	
	<li class="chapter" data-level="1.1" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> Jekyll </a><ul>
	
	
	<li class="chapter" data-level="1.2" data-path="http://localhost:4000"><a href="" onclick="pageScrollToTop(this)"> Install </a><ul>
	
	
	<li class="">
    	<a href="/pages/jekyll/install/how_to_install_ruby" onclick="pageScrollToTop(this)"> 安裝 Ruby on Mac</a>
        
            
        </li></ul></li></ul></li></ul>
    </nav>
</div>
            <div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >socket</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/pages/c/socket/socket">socket</h1>
                    

                    <p>Prerequisites:</p>
<ul>
  <li><a href="/pages/c/file/file_desc/#fd">File description</a></li>
  <li><a href="/pages/c/libc/errno/">errno</a></li>
  <li><a href="/pages/c/basic/main/">main</a></li>
  <li><a href="/pages/c/compile/makefile/">linux下編譯c++</a></li>
</ul>

<h2 id="socket函式">socket()函式</h2>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<ul>
  <li>失敗傳回-1，錯誤訊息已放至<a href="/pages/c/libc/errno/">errno</a></li>
  <li>成功傳回<a href="/pages/c/file/file_desc/#fd">fd</a></li>
</ul>

<h3 id="參數domain">參數domain</h3>

<p>固定用AF_INET</p>

<p>AF_INET支援TCP與UDP通訊傳輸協定。</p>

<h3 id="參數type">參數type</h3>

<table>
  <tbody>
    <tr>
      <td>SOCK_STREAM</td>
      <td>使用在TCP可靠傳輸協議，封包不會丟失</td>
    </tr>
    <tr>
      <td>SOCK_DGRAM</td>
      <td>使用在UDP不可靠傳輸協議，封包會丟失</td>
    </tr>
  </tbody>
</table>

<h3 id="參數protocol">參數protocol</h3>

<h4 id="ipproto_tcp">IPPROTO_TCP</h4>
<p>建立TCP socket語法</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<h4 id="ipproto_udp">IPPROTO_UDP</h4>
<p>建立UDP socket語法</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">IPPROTO_UDP</span><span class="p">);</span> 
</pre></td></tr></tbody></table></code></pre>
</figure>

<h2 id="big-endian">big-endian</h2>
<p>網路傳輸以big-endian方式傳輸。</p>

<p>電腦是以little-endian方式進行記憶體儲存，但在網路傳輸，一律轉成big-Endian。</p>

<p>host，主機，伺服器提供網站服務，此時這個伺服器是主機。</p>

<h2 id="port轉成big-endian">port轉成big-endian</h2>
<p>透過以下語法把port互轉為big-Endian與little-endian</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="c1">// port轉成big-endian</span>
<span class="kt">uint16_t</span> <span class="n">h</span> <span class="n">to</span> <span class="n">n</span> <span class="nf">s</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">hostshort</span><span class="p">);</span>  <span class="c1">// uint16_t 2byte unsigned short</span>
<span class="kt">uint32_t</span> <span class="nf">htonl</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">hostlong</span><span class="p">);</span>      <span class="c1">// uint32_t 4byte unsigned int</span>
<span class="c1">// big-endian的port轉成little-endian</span>
<span class="kt">uint16_t</span> <span class="n">n</span> <span class="n">to</span> <span class="n">h</span> <span class="nf">s</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">netshort</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="nf">ntohl</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">netlong</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>h = host(主機)</p>

<p>to = 轉</p>

<p>n = network(網路)</p>

<p>s = short(2byte=16bit)</p>

<p>l = long(4byte=32bit)</p>

<h2 id="sockaddr結構">sockaddr結構</h2>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sa_family</span><span class="p">;</span>  <span class="c1">// 固定填AF_INET</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span> <span class="c1">// 14byte的ip與port</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<h2 id="sockaddr_in結構">sockaddr_in結構</h2>
<p>大小與sockaddr結構一模一樣，但sockaddr結構的sa_data[14]範圍太大，此sockaddr_in結構補足sockaddr的不足。</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="p">{</span>  
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sin_family</span><span class="p">;</span>  <span class="c1">// 固定填AF_INET</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sin_port</span><span class="p">;</span>    <span class="c1">// 16bit,2byte port number,用htons()函式轉成big-endian</span>
  <span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>	  <span class="c1">// ip結構32bit,4byte</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>  <span class="c1">// 未使用，主要補足14byte - (ip 4byte) - (port 2byte) = 8 byte</span>
<span class="p">};</span>
<span class="c1">// ip結構</span>
<span class="k">struct</span> <span class="nc">in_addr</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_addr</span><span class="p">;</span>  <span class="c1">// 32bit,4byte ip 透過gethostbyname()函式轉成big-endian</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>在呼叫connect()函式時，再把sockaddr_in結構轉成sockaddr結構，二者記憶體大小都一樣，可以轉換。</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<h2 id="ip轉成big-endian">ip轉成big-endian</h2>
<p>gethostbyname()函式將ip轉成big-endian</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">hostent</span><span class="o">*</span> <span class="nf">gethostbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<ul>
  <li><a href="/pages/c/basic/include/">define</a></li>
</ul>

<p>hostent結構</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="nc">hostent</span> <span class="p">{</span> 
  <span class="kt">char</span><span class="o">*</span> <span class="n">h_name</span><span class="p">;</span>      <span class="c1">// 主機名</span>
  <span class="kt">char</span><span class="o">**</span> <span class="n">h_aliases</span><span class="p">;</span>  <span class="c1">// 主機別名</span>
  <span class="kt">short</span> <span class="n">h_addrtype</span><span class="p">;</span>  <span class="c1">// ip類型，固定填AF_INET</span>
  <span class="kt">short</span> <span class="n">h_length</span><span class="p">;</span>    <span class="c1">// ip長度, ipv4 是4 byte</span>
  <span class="kt">char</span><span class="o">**</span> <span class="n">h_addr_list</span><span class="p">;</span>  <span class="c1">//ip address以big-endian存放</span>
<span class="p">};</span>
<span class="cp">#define h_addr h_addr_list[0]  // h_addr是h_addr_list[0]的別名</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<p>透過以下語法將轉成big-endian的ip拷貝到sockaddr_in結構</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sockaddr_in</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">,</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<h2 id="client建立socket">client建立socket</h2>

<p>建立socket流程如下:</p>

<p>socket()函式 -&gt; 轉換ip與port變成big-endian -&gt; connect()</p>

<p>傳輸流程如下:</p>

<p>send()傳送資料 -&gt; recv()接收資料</p>

<p>完整程式碼</p>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"請輸入 ./client_test ip port"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 建立socket，失敗傳回-1</span>
  <span class="kt">int</span> <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">socket_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"socket"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// server ip轉big-endian</span>
  <span class="k">struct</span> <span class="nc">hostent</span><span class="o">*</span> <span class="n">h</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"gethostbyname() fail."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 關閉socket</span>
    <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// sockaddr_in結構</span>
  <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="c1">// server ip</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
  <span class="c1">// server port</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
  <span class="c1">// connect伺服器，傳回值為0代表連線成功，不是0代表連線失敗</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"connect"</span><span class="p">);</span>
    <span class="c1">// 關閉socket</span>
    <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// send data給伺服器</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 宣告send()與recv()的傳回值</span>
    <span class="kt">int</span> <span class="n">iret</span><span class="p">;</span>
    <span class="c1">// 清空buffer</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="c1">// sprintf 格式化輸出到 buffer 裡。</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"data %d"</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">// send buffer to server</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">iret</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"send"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"傳送給伺服器 = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 清空buffer</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="c1">// 收伺服器的回應</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">iret</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"iret = "</span> <span class="o">&lt;&lt;</span> <span class="n">iret</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"伺服器的回應 = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">//暫停1秒</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<h2 id="server">server</h2>

<h3 id="systemctl">systemctl</h3>

<p>以下bash指令都是在ubuntu下進行</p>

<p>systemctl指令是對服務進行管理</p>

<p>語法</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl 操作 服務名
</code></pre></div></div>

<p>以下為開啟服務，停止服務，重啟服務，查看服務狀態，檢查是否啟動</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl start 服務名
$ sudo systemctl stop 服務名
$ sudo systemctl restart 服務名
$ sudo systemctl status 服務名
$ sudo systemctl is-active 服務名
</code></pre></div></div>

<p>Linux重新開機後會自動啟動服務</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl enable 服務名
</code></pre></div></div>

<p>Linux重新開機後會關閉自動啟動服務</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl disable 服務名
</code></pre></div></div>

<p>查看是否為開始自動啟動服務</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl is-enabled 服務名
</code></pre></div></div>

<h3 id="防火牆">防火牆</h3>
<p>以下步驟是更新 -&gt; 安裝防火牆 -&gt; 啟動防火牆 -&gt; 查看防火牆狀態為active(啟動)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get update
$ sudo apt-get install ufw
$ sudo systemctl start ufw
$ sudo systemctl status ufw
● ufw.service
     Loaded: not-found (Reason: Unit ufw.service not found.)
     Active: active (exited) since Wed 2025-01-15 09:24:41 CST; 8min ago
   Main PID: 31048 (code=exited, status=0/SUCCESS)
        CPU: 501ms
</code></pre></div></div>

<h3 id="open-listen-port">open listen port</h3>
<p>增加對外開放的port</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo ufw allow 1234
$ sudo ufw status

狀態： 啓用

至                          動作          來自
-                          --          --
1234                       ALLOW       Anywhere                  
1234 (v6)                  ALLOW       Anywhere (v6)  
</code></pre></div></div>

<p>增加iptable</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo iptables -I INPUT -p tcp -m tcp --dport 1234 -j ACCEP
$ sudo iptables -L -n
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     6    --  0.0.0.0/0            0.0.0.0/0            tcp dpt:1234

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination     
</code></pre></div></div>

<h3 id="編譯執行程式">編譯執行程式</h3>

<p>編譯執行此頁最下面<a href="#server程式碼">server程式碼</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vi server_test.cpp
$ g++ -o server_test server_test.cpp
$ ./server_test 1234
</code></pre></div></div>

<p>打開另一個ssh終端機，要確認有0 0.0.0.0:1234</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo netstat -tunlp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.54:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN      33757/./server_test 
</code></pre></div></div>

<p>打開另一個ssh終端機，檢查是否能連上1234 port</p>

<p>有出現’^]’這個符號，代表可以連上。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ telnet 192.168.235.128 1234
Trying 192.168.235.128...
Connected to 192.168.235.128.
Escape character is '^]'.
</code></pre></div></div>

<p>打開另一個ssh終端機，把上面<a href="#client建立socket">client建立socket程式碼</a>編譯執行</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vi client_test.cpp
$ g++ -o client_test client_test.cpp
$ ./client_test 192.168.235.128 1234
</code></pre></div></div>

<p>執行結果</p>

<p>sever_test</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./server_test 1234
client已連上
收到client data = data 1
send = ok
收到client data = data 2
send = ok
收到client data = data 3
send = ok
iret = 0
</code></pre></div></div>

<p>client_test</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./client_test 192.168.235.128 1234
傳送給伺服器 = data 1
伺服器的回應 = ok
傳送給伺服器 = data 2
伺服器的回應 = ok
傳送給伺服器 = data 3
伺服器的回應 = ok
</code></pre></div></div>

<h3 id="server程式碼">server程式碼</h3>

<p>建立監聽socket與接受clinet連線的流程:</p>

<p>建立監聽listen socket()函式 -&gt; 轉換port變成big-endian -&gt; bind()綁定ip與port -&gt; listen()開始監聽 -&gt; accept()接受client連線，傳回client socket</p>

<p>傳輸流程如下:</p>

<p>send()傳送資料 -&gt; recv()接收資料</p>

<p>監聽socket與client socket的區別:</p>
<ul>
  <li>監聽listen socket只能建立連線</li>
  <li>client的socket可以與用戶端傳送與接收資料</li>
</ul>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"請輸入 ./server_test port"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 建立監聽fd listen_fd，失敗傳回-1</span>
  <span class="kt">int</span> <span class="n">listen_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">listen_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"socket"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// sockaddr_in結構</span>
  <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="c1">// server port</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
  <span class="c1">// server有多個ip，所有ip都會監聽port</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
  <span class="c1">// 綁定監聽器，失敗傳回-1</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"bind error"</span><span class="p">);</span>
    <span class="c1">// 關閉監聽器</span>
    <span class="n">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 最多只讓3個client同時連server</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"listen"</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 接受client連接</span>
  <span class="kt">int</span> <span class="n">client_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">client_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"accept"</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"client已連上"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="c1">// 一定要用無限循環，等待client連上來</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">iret</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="c1">// 如果client沒有send data，recv()會等待</span>
    <span class="c1">// 如果client斷線，recv()傳回0</span>
    <span class="c1">// iret = -1 失敗</span>
    <span class="c1">// iret = 0 socket斷線</span>
    <span class="c1">// iret &gt; 0 收到資料    </span>
    <span class="k">if</span> <span class="p">((</span><span class="n">iret</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"iret = "</span> <span class="o">&lt;&lt;</span> <span class="n">iret</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="c1">// 斷線 = 0就跳出無限循環</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"收到client data = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 建立回應的資料給client</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"ok"</span><span class="p">);</span>
    <span class="c1">// 傳送回應的資料</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">iret</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"send"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"send = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
  <span class="n">close</span><span class="p">(</span><span class="n">client_fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<hr />

<h2 id="封裝socket">封裝Socket</h2>

<p>Prerequisites:</p>
<ul>
  <li><a href="/pages/c/stl/string/#讀取string位置">使用陣列索引取得記憶體位址</a></li>
  <li><a href="/pages/c/stl/string/#取得string物件存放字串的記憶體位址">data()取得記憶體位址</a></li>
  <li><a href="/pages/c/string/string_convert/#char-to-string">cstring與string連結</a></li>
  <li><a href="/pages/c/stl/string/#resize">resize()</a></li>
  <li><a href="/pages/c/stl/string/#取得string物件實際使用大小">string size</a></li>
  <li><a href="/pages/c/stl/string/#字串作為函式參數">string參數</a></li>
</ul>

<p>封裝，物件導向中用來實作資訊隱藏的機制，確保物件的安全。其作法為：隱藏不想讓外界碰觸的成員，只公開接受外界存取的成員。</p>

<p>使用::connect()，::二個冒號是使用Standard Library中的全域函式connect()，並不是自己建立的成員函式connect()。</p>

<p><code class="language-plaintext highlighter-rouge">send(const string &amp;buffer)</code>，參數使用const string是因為既可支援string，也可支援const char*</p>

<h3 id="client">client</h3>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">TCPClient</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="c1">// 建構子，初始化client_fd，-1代表沒有連線</span>
  <span class="n">TCPClient</span><span class="p">()</span> <span class="o">:</span> <span class="n">client_fd_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
  <span class="kt">bool</span> <span class="n">connect</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// client_fd若已連線，就不用再連，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">ip_</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
    <span class="n">port_</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
    <span class="n">client_fd_</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
    <span class="c1">// socket失敗傳回-1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">// server ip轉big-endian</span>
    <span class="k">struct</span> <span class="nc">hostent</span><span class="o">*</span> <span class="n">h</span><span class="p">;</span>
    <span class="c1">// gethostbyname需要cstring，所以要把string轉成cstring</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">ip_</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"gethostbyname() fail."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="c1">// 關閉socket</span>
      <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">);</span>
      <span class="c1">// 失敗把client_fd還原成初始化-1</span>
      <span class="n">client_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// sockaddr_in結構</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="c1">// server ip</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
    <span class="c1">// server port</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port_</span><span class="p">);</span>
    <span class="c1">// connect伺服器，傳回值為0代表連線成功，不是0代表連線失敗</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">connect</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 關閉socket</span>
      <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">);</span>
      <span class="c1">// 失敗把client_fd還原成初始化-1</span>
      <span class="n">client_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 參數使用const string是因為既可支援string，也可支援const char*</span>
  <span class="kt">bool</span> <span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// client_fd若已斷線，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">// send()第2個參數填記憶體位址，第3個參數填大小</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 第一個參數要修改buffer的內容，所以不加const</span>
  <span class="kt">bool</span> <span class="n">recv</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 清空string</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="c1">// 分配記憶體大小</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">maxlen</span><span class="p">);</span>
    <span class="c1">// 收到的資料放在buffer的記憶體空間</span>
    <span class="c1">// 操作到string的記憶體位址，有對string物件進行讀取與寫入</span>
    <span class="c1">// 第2個參數填不是const的記憶體位址，第3個參數填大小</span>
    <span class="c1">// &amp;buffer[0]取得位址，傳回值不是const</span>
    <span class="c1">// buffer.data()傳回值是const，所以不用</span>
    <span class="c1">// recv()傳回值是收到的資料大小</span>
    <span class="kt">int</span> <span class="n">iret</span> <span class="o">=</span> <span class="o">::</span><span class="n">recv</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// iret = -1 失敗</span>
    <span class="c1">// iret = 0 socket斷線</span>
    <span class="c1">// iret &gt; 0 收到資料</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 失敗時把buffer清空，否則buffer大小一直維持1024</span>
      <span class="n">buffer</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 如果有操作到string的記憶體位址，string的自動擴展空間會失效</span>
    <span class="c1">// 需要自己重設string大小</span>
    <span class="c1">// 從1024大小，設為真正收到資料的大小</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">iret</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">close</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// client_fd若已斷線，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">);</span>
    <span class="n">client_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">TCPClient</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">close</span><span class="p">();</span>
  <span class="p">}</span>
 <span class="nl">private:</span>
  <span class="kt">int</span> <span class="n">client_fd_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">ip_</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port_</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"請輸入 ./client_test ip port"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 建立socket</span>
  <span class="n">TCPClient</span> <span class="n">tcp_client</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcp_client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"socket"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// send data給伺服器</span>
  <span class="n">string</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="s">"data "</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="c1">// send buffer to server</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp_client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"send"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"傳送給伺服器 = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 收伺服器的回應，若伺服器沒回應，就會一直停在這裡等待回應，不會往下執行</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp_client</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"rev"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"伺服器的回應 = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">//暫停1秒</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

<h3 id="server-1">server</h3>

<figure class="highlight">
  <pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">TCPServer</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="c1">// 建構子</span>
  <span class="c1">// 監聽listen_fd，-1代表未初始化</span>
  <span class="c1">// client_fd，-1代表未連線</span>
  <span class="n">TCPServer</span><span class="p">()</span> <span class="o">:</span> <span class="n">listen_fd_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">client_fd_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
  <span class="c1">// 初始化監聽的socket</span>
  <span class="kt">bool</span> <span class="n">initListen</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">listen_fd_</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">port_</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
    <span class="c1">// sockaddr_in結構</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="c1">// server port</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port_</span><span class="p">);</span>
    <span class="c1">// server有多個ip，所有ip都會監聽port</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
    <span class="c1">// socket綁定ip與port</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">listen_fd_</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 關閉監聽器</span>
      <span class="n">close</span><span class="p">(</span><span class="n">listen_fd_</span><span class="p">);</span>
      <span class="n">listen_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 把socket設為監聽的狀態</span>
    <span class="c1">// 最多只讓3個client同時連server</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">listen_fd_</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">close</span><span class="p">(</span><span class="n">listen_fd_</span><span class="p">);</span>
      <span class="n">listen_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">accept</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// client的ip結構</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">addr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
    <span class="c1">// 接受client的連線</span>
    <span class="c1">// 若要得到client的ip，第二個參數填sockaddr_in結構，第3個參數填結構大小</span>
    <span class="c1">// 若不想得到client ip，第2與第3參數填0就好</span>
    <span class="n">client_fd_</span> <span class="o">=</span> <span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">listen_fd_</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">// 取得client的ip</span>
    <span class="c1">// 透過inet_ntoa把big-endian轉成little-endian</span>
    <span class="n">client_ip_</span> <span class="o">=</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">getClientIp</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">client_ip_</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果client fd是-1就沒必要繼續後面的動作，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">// send()第2個參數填記憶體位址，第3個參數填大小</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 第一個參數要修改buffer的內容，所以不加const</span>
  <span class="kt">bool</span> <span class="n">recv</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 清空string</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="c1">// 分配記憶體大小</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">maxlen</span><span class="p">);</span>
    <span class="c1">// 收到的資料放在buffer的記憶體空間</span>
    <span class="c1">// 操作到string的記憶體位址，有對string物件進行讀取與寫入</span>
    <span class="c1">// 第2個參數填不是const的記憶體位址，第3個參數填大小</span>
    <span class="c1">// &amp;buffer[0]取得位址，傳回值不是const</span>
    <span class="c1">// buffer.data()傳回值是const，所以不用</span>
    <span class="c1">// recv()傳回值是收到的資料大小</span>
    <span class="kt">int</span> <span class="n">iret</span> <span class="o">=</span> <span class="o">::</span><span class="n">recv</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// iret = -1 失敗</span>
    <span class="c1">// iret = 0 socket斷線</span>
    <span class="c1">// iret &gt; 0 收到資料</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"iret = "</span> <span class="o">&lt;&lt;</span> <span class="n">iret</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="c1">// 失敗時把buffer清空，否則buffer大小一直維持1024</span>
      <span class="n">buffer</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 如果有操作到string的記憶體位址，string的自動擴展空間會失效</span>
    <span class="c1">// 需要自己重設string大小</span>
    <span class="c1">// 從1024大小，設為真正收到資料的大小</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">iret</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 關閉監聽socket</span>
  <span class="kt">bool</span> <span class="n">closeListen</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 若未初始化，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">listen_fd_</span><span class="p">);</span>
    <span class="c1">// 設為未初始化-1</span>
    <span class="n">listen_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 關閉client socket</span>
  <span class="kt">bool</span> <span class="n">closeClient</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// client_fd若已斷線，直接返回</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_fd_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">client_fd_</span><span class="p">);</span>
    <span class="c1">// 設成未連線-1</span>
    <span class="n">client_fd_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">TCPServer</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 解構子把二個socket都關掉</span>
    <span class="n">closeListen</span><span class="p">();</span>
    <span class="n">closeClient</span><span class="p">();</span>
  <span class="p">}</span>
 <span class="nl">private:</span>
  <span class="kt">int</span> <span class="n">listen_fd_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">client_fd_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">client_ip_</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port_</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"請輸入 ./server_test port"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 建立監聽fd listen_fd</span>
  <span class="n">TCPServer</span> <span class="n">tcpServer</span><span class="p">;</span>
  <span class="c1">// 初始化監聽</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcpServer</span><span class="p">.</span><span class="n">initListen</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"initListen"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 接受client連接</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcpServer</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"accept"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"client已連上 = "</span> <span class="o">&lt;&lt;</span> <span class="n">tcpServer</span><span class="p">.</span><span class="n">getClientIp</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果client沒有send data，recv()會等待</span>
    <span class="c1">// 收到0，代表斷線</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcpServer</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"recv()"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"收到client data = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 建立回應的資料給client</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="s">"ok"</span><span class="p">;</span>
    <span class="c1">// 傳送回應的資料</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcpServer</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"send"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"send = "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</figure>

</section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


<!-- introduce mathjax support -->
<script>
    function fixes_chrome_anchors() {
        let chrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        if (window.location.hash && chrome) {
            setTimeout(function () {
                var hash = window.location.hash;
                window.location.hash = "";
                window.location.hash = hash;
            }, 300);
        }
    }

    if (document.readyState === "loading") {
        // Loading hasn't finished yet
        document.addEventListener("DOMContentLoaded", fixes_chrome_anchors);
    } else {
        // `DOMContentLoaded` has already fired
        fixes_chrome_anchors();
    }
</script>

<!------上一頁與下一頁 start---------->
                    
                    
                    
                    
    
                    
                        
                        <a href="/pages/c/libc/semaph_que" class="navigation navigation-prev navigation-unique" aria-label="Previous page: semaphore作為condition">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    

                    
                        
                        <a href="/pages/c/socket/fork_socket" class="navigation navigation-next navigation-unique" aria-label="Next page: 多工的socket">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    
                    <!------上一頁與下一頁 end---------->
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "include與define",
            "level": "1.2",
            "depth": 1,
            "path": "_pages/c/basic/include.md",
            "ref": "_pages/c/basic/include.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "expandable-chapter-small2": {
                "articlesExpand": true,
            },
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": true,

                "google": false,

                "github": true,
              
                "github_link": "https://github.com",
              

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": true,
              

                "vk": false,

                "weibo": false,

                "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"]
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            },
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Cici's notebook",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_pages/c/socket/socket.md",
        "mtime": "2025-01-12 00:00:00 +0800",
        "type": "markdown"
    },
    "gitbook": {
        "version": "",
        "time": "2025-02-24 11:03:17 +0800"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
<script src="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.js"></script>
<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
<script src="/assets/gitbook/gitbook-plugin-splitter/splitter.js"></script>

<!--
<script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script>
-->

<script src="/assets/gitbook/custom.js"></script>
<script src="/assets/gitbook/custom-local.js"></script>

</body>
</html>